<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hola Live | Pro Streaming Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #7df9ff; --gold: #ffcf40; --danger: #ff0055; 
            --blue: #0055ff; --panel: rgba(0, 0, 0, 0.4); 
        }

        body { 
            margin: 0; font-family: 'Inter', sans-serif; background: #000; 
            height: 100vh; color: #fff; overflow: hidden; display: flex; flex-direction: column; 
        }

        /* --- STREAM DISPLAY --- */
        .video-viewport { 
            flex: 1; position: relative; background: #05070f; 
            display: flex; align-items: center; justify-content: center;
        }
        .stream-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

        /* --- PK BATTLE SYSTEM --- */
        #pkOverlay {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 100; display: none;
        }
        .pk-timer { text-align: center; font-weight: 900; color: var(--gold); font-size: 12px; margin-bottom: 4px; text-shadow: 0 2px 4px #000; }
        .pk-track { 
            height: 24px; background: #222; border-radius: 12px; overflow: hidden; 
            display: flex; border: 2px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;
        }
        #pkLeft { height: 100%; background: linear-gradient(90deg, var(--danger), #ff8800); width: 50%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; padding-left: 10px; font-weight: 900; font-size: 11px; }
        #pkRight { flex: 1; background: linear-gradient(90deg, var(--blue), #00d4ff); display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; font-weight: 900; font-size: 11px; }
        .vs-tag { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; }

        /* --- ENTRY EFFECTS (Dragon, Rocket, Car) --- */
        #entryCanvas { position: absolute; inset: 0; pointer-events: none; z-index: 500; display: flex; align-items: center; justify-content: center; }
        
        .entry-anim { animation: entryIn 3s ease-in-out forwards; text-align: center; }
        .entry-icon { font-size: 80px; filter: drop-shadow(0 0 20px var(--gold)); }
        .entry-name { font-weight: 900; font-size: 22px; color: #fff; text-shadow: 0 0 10px var(--accent); margin-top: 10px; text-transform: uppercase; }

        @keyframes entryIn {
            0% { transform: translateY(600px) scale(0.5); opacity: 0; }
            30% { transform: translateY(0) scale(1.2); opacity: 1; }
            70% { transform: translateY(0) scale(1.2); opacity: 1; }
            100% { transform: translateY(-600px) scale(0.5); opacity: 0; }
        }

        /* --- LUCKY BOX --- */
        #luckyBox {
            position: absolute; font-size: 50px; cursor: pointer; z-index: 200;
            display: none; animation: bounce 0.5s infinite alternate; filter: drop-shadow(0 0 15px var(--gold));
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.2); } }

        /* --- CHAT SECTION --- */
        #chatDisplay { 
            height: 35vh; background: linear-gradient(transparent, rgba(0,0,0,0.9)); 
            padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
        }
        .chat-line { background: rgba(255,255,255,0.08); padding: 8px 12px; border-radius: 12px; font-size: 13px; max-width: 85%; border-left: 3px solid var(--accent); animation: fadeIn 0.3s forwards; }
        .chat-line b { color: var(--accent); }
        .chat-line.vip { border-left-color: var(--gold); background: rgba(255, 207, 64, 0.1); }
        .chat-line.admin { border-left-color: var(--danger); background: rgba(255, 0, 85, 0.15); font-weight: 700; }

        /* --- CONTROLS --- */
        .action-bar { padding: 10px; display: flex; gap: 8px; background: #000; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .chat-input { flex: 1; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px 18px; border-radius: 25px; outline: none; font-size: 14px; }
        .gift-btn { background: var(--gold); border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        .send-btn { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; }

        /* GIFTS PANEL */
        #giftPanel {
            position: absolute; bottom: 0; left: 0; right: 0; background: #0d1224; 
            border-top-left-radius: 25px; border-top-right-radius: 25px; 
            padding: 20px; display: none; z-index: 1000;
        }
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gift-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; text-align: center; }
        .gift-card:active { background: var(--accent); color: #000; }
    </style>
</head>
<body>

    <div class="video-viewport">
        <img src="https://picsum.photos/id/65/1280/720" class="stream-img">

        <div id="pkOverlay">
            <div class="pk-timer">PK BATTLE | <span id="timerText">05:00</span></div>
            <div class="pk-track">
                <div id="pkLeft">0</div>
                <div id="pkRight">0</div>
                <div class="vs-tag">VS</div>
            </div>
        </div>

        <div id="entryCanvas"></div>

        <div id="luckyBox" onclick="claimLuckyBox()">üéÅ</div>

        <div style="position:absolute; top:20px; left:15px; display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.5); padding:6px 12px; border-radius:30px; backdrop-filter:blur(10px);">
            <div style="width:32px; height:32px; background:var(--accent); border-radius:50%; border:2px solid #fff;"></div>
            <div>
                <div style="font-weight:900; font-size:12px;">Anu_B <span style="color:var(--gold)">üëë</span></div>
                <div style="font-size:9px; opacity:0.8;">üë§ <span id="vCount">2,410</span> “Ø–∑—ç–≥—á–∏–¥</div>
            </div>
        </div>
    </div>

    <div id="chatDisplay">
        <div class="chat-line admin">System: Hola Live-–¥ —Ç–∞–≤—Ç–∞–π –º–æ—Ä–∏–ª! –°–æ—ë–ª—Ç–æ–π —Ö–∞—Ä–∏–ª—Ü–∞–Ω–∞ —É—É.</div>
    </div>

    <div class="action-bar">
        <button class="gift-btn" onclick="toggleGifts()">üíé</button>
        <input type="text" id="msgInput" class="chat-input" placeholder="–ß–∞—Ç –±–∏—á–∏—Ö...">
        <button class="send-btn" onclick="sendMessage()">üöÄ</button>
    </div>

    <div id="giftPanel">
        <h3 style="margin-top:0; font-size:16px;">–ë—ç–ª—ç–≥ –∏–ª–≥—ç—ç—Ö</h3>
        <div class="gift-grid">
            <div class="gift-card" onclick="sendGift('Rose', 'üåπ', 10)"><div>üåπ</div><div style="font-size:10px;">10</div></div>
            <div class="gift-card" onclick="sendGift('Rocket', 'üöÄ', 500)"><div>üöÄ</div><div style="font-size:10px;">500</div></div>
            <div class="gift-card" onclick="sendGift('Car', 'üèéÔ∏è', 1000)"><div>üèéÔ∏è</div><div style="font-size:10px;">1000</div></div>
            <div class="gift-card" onclick="sendGift('Dragon', 'üêâ', 5000)"><div>üêâ</div><div style="font-size:10px;">5000</div></div>
        </div>
        <button onclick="toggleGifts()" style="width:100%; margin-top:15px; padding:10px; border:none; border-radius:10px;">–•–∞–∞—Ö</button>
    </div>

    <script src="../js/eventBus.js"></script>
    <script src="../js/economyEngine.js"></script>
    <script src="../js/adminEngine.js"></script>
    
    <script>
        let pkActive = false;
        let pkScores = { left: 0, right: 0 };
        const myUserId = "user_777"; 

        // 1. ENTRY EFFECT SYSTEM (On Load)
        window.onload = () => {
            const vehicle = JSON.parse(localStorage.getItem('user_vehicle'));
            const coolId = localStorage.getItem('cool_id');
            
            if(vehicle && vehicle.expire > Date.now()) {
                const canvas = document.getElementById('entryCanvas');
                let icon = vehicle.type === 'rocket' ? 'üöÄ' : (vehicle.type === 'car' ? 'üèéÔ∏è' : 'üêâ');
                let name = vehicle.type.toUpperCase();

                canvas.innerHTML = `
                    <div class="entry-anim">
                        <div class="entry-icon">${icon}</div>
                        <div class="entry-name">${coolId ? coolId : 'LEGEND USER'} –û–†–ñ –ò–†–õ–≠–≠!</div>
                    </div>
                `;
                setTimeout(() => canvas.innerHTML = '', 3500);
            }
        };

        // 2. CHAT & ADMIN BAN SYSTEM
        function sendMessage() {
            // Check Ban
            const banUntil = localStorage.getItem(`ban_${myUserId}`);
            if(banUntil && Date.now() < parseInt(banUntil)) {
                alert("–¢–∞ —á–∞—Ç –±–∏—á–∏—Ö —ç—Ä—Ö—ç—ç —Ö–∞—Å—É—É–ª—Å–∞–Ω –±–∞–π–Ω–∞!");
                return;
            }

            const input = document.getElementById('msgInput');
            if(input.value.trim() === "") return;
            
            addChatLine("–ë–∏", input.value, localStorage.getItem('cool_id') ? 'vip' : '');
            input.value = "";
        }

        function addChatLine(user, text, type = '') {
            const chat = document.getElementById('chatDisplay');
            const div = document.createElement('div');
            div.className = `chat-line ${type}`;
            div.innerHTML = `<b>${user}:</b> ${text}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // 3. GIFTING & PK SYNC
        function toggleGifts() {
            const panel = document.getElementById('giftPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function sendGift(name, icon, price) {
            const success = EconomyEngine.processGift({
                user: localStorage.getItem('cool_id') || "User",
                streamer: "Anu_B",
                giftName: name,
                icon: icon,
                price: price
            });

            if(success) {
                addChatLine("–ë–∏", `${icon} ${name} –∏–ª–≥—ç—ç–ª—ç—ç!`, 'vip');
                if(pkActive) updatePK(price);
                toggleGifts();
            } else {
                alert("Diamond —Ö“Ø—Ä—ç–ª—Ü—ç—Ö–≥“Ø–π –±–∞–π–Ω–∞!");
            }
        }

        // 4. PK LOGIC
        function updatePK(amount) {
            pkScores.left += amount;
            refreshPKBar();
        }

        function refreshPKBar() {
            const total = pkScores.left + pkScores.right;
            const percent = total === 0 ? 50 : (pkScores.left / total) * 100;
            document.getElementById('pkLeft').style.width = percent + '%';
            document.getElementById('pkLeft').innerText = pkScores.left;
            document.getElementById('pkRight').innerText = pkScores.right;
        }

        // 5. GLOBAL EVENT LISTENERS (Lucky Box & PK Start)
        EventBus.listen((data) => {
            if(data.type === 'SPAWN_BOX') {
                const box = document.getElementById('luckyBox');
                box.style.left = Math.random() * 70 + 10 + '%';
                box.style.top = Math.random() * 50 + 20 + '%';
                box.style.display = 'block';
            }
            if(data.type === 'BATTLE_STARTED') {
                pkActive = true;
                pkScores = { left: 0, right: 2500 }; // Random competitor score
                document.getElementById('pkOverlay').style.display = 'block';
                refreshPKBar();
            }
        });

        function claimLuckyBox() {
            const win = Math.floor(Math.random() * 50) + 5;
            EconomyEngine.updateWallet(win);
            alert(`üéÅ –ë–∞—è—Ä —Ö“Ø—Ä–≥—ç–µ! ${win} üíé —Ö–æ–∂–ª–æ–æ.`);
            document.getElementById('luckyBox').style.display = 'none';
        }
    </script>
</body>
</html>
